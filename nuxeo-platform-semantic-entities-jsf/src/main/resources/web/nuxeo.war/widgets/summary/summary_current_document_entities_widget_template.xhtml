<div class="entities_block" xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:nxdir="http://nuxeo.org/nxdirectory"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:rich="http://richfaces.org/rich">
<!--
 TODO: Rewrite this as a generic widget that uses parameterized
       content views (once the CMISQL-joins enabled provider is
       factorized out of the project
 -->

<a4j:region renderRegionOnly="true">
<a4j:outputPanel id="relatedEntitiesPanel">

<a4j:poll interval="1000"
 enabled="#{!empty semanticWorkInProgressMessage}"
 reRender="relatedEntitiesPanel" />

<f:subview rendered="#{!empty semanticWorkInProgressMessage}">
  <div class="semanticWorkInProgressMessage">
    #{messages[semanticWorkInProgressMessage]}
   <span style="width: 1em"/>
   <h:graphicImage value="/img/standart_waiter.gif" />
  </div>
</f:subview>

<f:subview rendered="#{false and empty semanticWorkInProgressMessage}">
  <a4j:commandButton value="#{messages['label.button.launchSemanticAnalysis']}"
   action="#{semanticEntitiesActions.launchAsyncAnalysis}"
   rendered="#{documentManager.hasPermission(currentDocument.ref, 'WriteProperties')}"
   onclick="this.disabled=true"
   oncomplete="this.disabled=false"
   reRender="relatedEntitiesPanel" />
</f:subview>

<f:subview rendered="#{!empty relatedPeopleProvider.currentPage}">
  <h3 class="summaryTitle">#{messages['heading.occurrencesOfPeople']}</h3>
  <c:forEach var="entity" items="#{relatedPeopleProvider.currentPage}">
    <nxl:layout name="entity_short_summary_layout" value="#{entity}" mode="view" />
  </c:forEach>
</f:subview>

<f:subview rendered="#{!empty relatedOrganizationsProvider.currentPage}">
  <h3 class="summaryTitle">#{messages['heading.occurrencesOfOrganizations']}</h3>
  <c:forEach var="entity" items="#{relatedOrganizationsProvider.currentPage}">
    <nxl:layout name="entity_short_summary_layout" value="#{entity}" mode="view" />
  </c:forEach>
</f:subview>

<f:subview rendered="#{!empty relatedPlacesProvider.currentPage}">
  <h3 class="summaryTitle">#{messages['heading.occurrencesOfPlaces']}</h3>
  <c:forEach var="entity" items="#{relatedPlacesProvider.currentPage}">
    <nxl:layout name="entity_short_summary_layout" value="#{entity}" mode="view" />
  </c:forEach>
</f:subview>

<f:subview rendered="#{empty semanticWorkInProgressMessage}">
  <h3 class="summaryTitle">#{messages['heading.linkToEntity']}</h3>
  <h:inputText id="entitySuggestionKeywords" styleClass="dataInputText"
    onkeydown="if (event.keyCode == 13 || event.keyCode == 9) {return false;}" />
  <a4j:status>
    <f:facet name="start">
      <h:graphicImage value="/img/standart_waiter.gif" />
    </f:facet>
  </a4j:status>
  <rich:suggestionbox
    suggestionAction="#{semanticEntitiesActions.suggestEntities}" var="entitySuggestion"
    for="entitySuggestionKeywords"
    nothingLabel="${messages['label.results.noMatchingEntity']}"
    ajaxSingle="true">
    <a4j:support event="onselect" reRender="relatedEntitiesPanel"
      action="#{semanticEntitiesActions.addNewOccurrenceRelation}"
      ajaxSingle="true">
      <f:setPropertyActionListener value="#{entitySuggestion}"
        target="#{semanticEntitiesActions.selectedSuggestion}" />
    </a4j:support>
    <h:column>
      <h:graphicImage
        url="/icons/#{entitySuggestion.type}.png"
        style="height: 16px; width: 16px; border: none; padding: 0"
        rendered="#{!empty entitySuggestion.type}"
        styleClass="entityDepiction" />
      #{entitySuggestion.label}
    </h:column>
  </rich:suggestionbox>
</f:subview>
</a4j:outputPanel>
</a4j:region>

</div>
